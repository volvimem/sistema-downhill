<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Cirurgia - DH PE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #f0f2f5; color: #333; padding-bottom: 80px; }

        /* CABEÇALHO */
        .header { background: #001233; color: white; padding: 20px 20px 60px 20px; position: relative; border-bottom: 5px solid #ffcc00; }
        .header-top { display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto; }
        .header h1 { font-size: 20px; font-weight: 900; text-transform: uppercase; }
        .btn-admin-login { background: none; border: none; color: #ffcc00; cursor: pointer; font-size: 18px; }

        .container { max-width: 600px; margin: -40px auto 20px auto; padding: 0 15px; position: relative; z-index: 10; }

        /* DASHBOARD FINANCEIRO */
        .card-financeiro {
            background: linear-gradient(135deg, #003399, #001233);
            color: white; padding: 25px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 30px rgba(0, 51, 153, 0.3); margin-bottom: 25px;
        }
        .label-caixa { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.8; }
        .valor-caixa { font-size: 40px; font-weight: 900; color: #ffcc00; margin: 5px 0; }
        .status-geral { display: flex; justify-content: center; gap: 30px; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .stat-item b { display: block; font-size: 18px; }
        .stat-item span { font-size: 10px; color: #aaa; text-transform: uppercase; }

        /* BOTÃO ADESÃO */
        .btn-adesao {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 20px; background: #27ae60; color: white;
            border: none; border-radius: 12px; font-weight: 900; font-size: 16px;
            text-transform: uppercase; cursor: pointer; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
            margin-bottom: 30px; transition: 0.3s;
        }
        .btn-adesao:hover { transform: scale(1.02); background: #219150; }

        /* LISTA DE ATLETAS */
        .card-lista { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .titulo-lista { color: #003399; font-weight: 800; font-size: 14px; text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .atleta-row { display: flex; align-items: flex-start; gap: 12px; padding: 15px 0; border-bottom: 1px solid #f5f5f5; }
        .foto-perfil { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; background: #ddd; }
        .info-atleta { flex: 1; }
        .nome { font-weight: 800; color: #333; display: block; font-size: 15px; }
        .cpf-mask { font-size: 11px; color: #777; letter-spacing: 1px; margin-bottom: 5px; }
        .valor-pago { font-weight: 900; color: #003399; font-size: 14px; align-self: flex-start; margin-top: 5px; }

        /* VISUAL DOS MESES PAGOS */
        .meses-grid { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
        .tag-mes { 
            font-size: 9px; font-weight: 800; padding: 3px 6px; border-radius: 4px; 
            background: #27ae60; color: white; text-transform: uppercase;
        }

        /* BADGES DE STATUS */
        .badge { font-size: 9px; font-weight: 900; padding: 3px 6px; border-radius: 4px; text-transform: uppercase; margin-left: 5px; display: inline-block; }
        .bg-analise { background: #eee; color: #777; border: 1px solid #ccc; }
        .bg-carencia { background: #fff3cd; color: #856404; }
        .bg-apto { background: #d4edda; color: #155724; }

        /* MODAIS */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 400px; position: relative; max-height: 95vh; overflow-y: auto; }
        
        /* PIX AREA */
        .pix-container { background: #e8f5e9; border: 2px dashed #27ae60; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .pix-titulo { color: #27ae60; font-weight: 900; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
        .pix-chave { font-family: monospace; font-size: 16px; font-weight: bold; background: white; padding: 8px; border-radius: 6px; display: block; margin: 5px 0; word-break: break-all; }
        .btn-copiar { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; margin-top: 5px; }
        .btn-copiar:active { background: #1e8449; transform: scale(0.95); }

        /* SELFIE AREA */
        .selfie-area { text-align: center; margin-bottom: 20px; }
        #preview-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; background: #f0f0f0; display: block; margin: 0 auto 15px auto; border: 4px solid #27ae60; }
        .btn-foto { background: #003399; color: white; padding: 10px 20px; border-radius: 8px; font-size: 12px; cursor: pointer; display: inline-block; font-weight: bold; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 11px; font-weight: bold; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; }
        
        .btn-finalizar { width: 100%; padding: 18px; background: #ffcc00; color: #001233; border: none; border-radius: 10px; font-weight: 900; font-size: 14px; cursor: pointer; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }

        /* CONTROLES ADM */
        .admin-controls { display: none; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px; gap: 5px; flex-wrap: wrap; }
        .btn-adm { padding: 8px 12px; border-radius: 6px; border: none; font-size: 10px; font-weight: bold; cursor: pointer; color: white; flex: 1; }
        .btn-ativar { background: #27ae60; }
        .btn-pay { background: #2980b9; }
        .btn-del { background: #c0392b; }
        
        /* Classe ativada via JS quando logado */
        .modo-adm-ativo .admin-controls { display: flex; }
        .modo-adm-ativo #status-adm-label { display: block !important; }

    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <h1>Plano Cirurgia DH PE</h1>
            <button class="btn-admin-login" onclick="loginAdmin()"><i class="fas fa-lock"></i></button>
        </div>
    </div>

    <div class="container">
        
        <div class="card-financeiro">
            <div class="label-caixa">SALDO TOTAL EM CAIXA</div>
            <div class="valor-caixa" id="saldo-total">R$ 0,00</div>
            <div class="status-geral">
                <div class="stat-item"><b id="qtd-aptos">0</b><span>APTOS</span></div>
                <div class="stat-item"><b id="qtd-carencia">0</b><span>CARÊNCIA</span></div>
                <div class="stat-item"><b id="qtd-analise">0</b><span>EM ANÁLISE</span></div>
            </div>
        </div>

        <button class="btn-adesao" onclick="abrirModal('modal-inscricao')">
            <i class="fas fa-file-invoice-dollar"></i> SOLICITAR ADESÃO AO PLANO
        </button>

        <div class="card-lista">
            <div class="titulo-lista">
                <span>Participantes</span>
                <span id="status-adm-label" style="color:#27ae60; display:none; font-size:10px; border:1px solid #27ae60; padding:2px 5px; border-radius:4px;">MODO ADM ATIVO</span>
            </div>
            <div id="lista-participantes"></div>
        </div>
        
        <p style="text-align: center; font-size: 11px; color: #999; margin-top: 20px;">
            Carência de 6 meses. Mensalidade R$ 100,00.<br>
            A ativação ocorre após a confirmação do pagamento pelo ADM.
        </p>
    </div>

    <div id="modal-inscricao" class="modal">
        <div class="modal-box">
            <button class="close-modal" onclick="fecharModal('modal-inscricao')">&times;</button>
            <h3 style="color:#003399; margin-bottom: 15px; text-align: center;">NOVA ADESÃO</h3>

            <div class="pix-container">
                <div class="pix-titulo"><i class="fas fa-qrcode"></i> CHAVE PIX</div>
                <span id="chave-pix" class="pix-chave">87999999999</span>
                <button class="btn-copiar" onclick="copiarPix()">COPIAR CHAVE PIX</button>
            </div>

            <div class="selfie-area">
                <img id="preview-img" src="https://via.placeholder.com/120?text=Selfie">
                <label class="btn-foto">
                    <i class="fas fa-camera"></i> TIRAR FOTO ROSTO
                    <input type="file" id="foto-input" accept="image/*" capture="user" style="display: none;" onchange="lerFoto(this)">
                </label>
            </div>

            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" id="nome" placeholder="Seu nome">
            </div>

            <div class="form-group">
                <label>CPF</label>
                <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14">
            </div>

            <button class="btn-finalizar" onclick="solicitarAdesao()">
                <i class="fab fa-whatsapp"></i> ENVIAR COMPROVANTE
            </button>
        </div>
    </div>

    <div id="modal-pagamento" class="modal">
        <div class="modal-box">
            <button class="close-modal" onclick="fecharModal('modal-pagamento')">&times;</button>
            <h3 style="color:#003399; margin-bottom: 15px; text-align: center;">REGISTRAR MENSALIDADE</h3>
            <p id="nome-atleta-pag" style="text-align:center; font-weight:bold; margin-bottom:15px;"></p>
            <input type="hidden" id="id-atleta-pag">

            <div class="form-group">
                <label>Qual mês foi pago?</label>
                <select id="mes-pagamento">
                    </select>
            </div>

            <button class="btn-finalizar" onclick="confirmarPagamentoMensal()">
                CONFIRMAR R$ 100,00
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÕES ---
        const ZAP_ADM = "5587999999999"; 
        const SENHA_ADM = "1234"; 
        const CHAVE_PIX_REAL = "87999999999"; 
        const VALOR_MENSAL = 100.00;

        document.getElementById('chave-pix').innerText = CHAVE_PIX_REAL;

        // --- DADOS DE EXEMPLO (PARA VISUALIZAÇÃO) ---
        const dadosExemplo = [
            {
                id: 101,
                nome: "Bruno Rocha (Exemplo Apto)",
                cpf: "123.456.789-00",
                foto: "https://i.pravatar.cc/150?img=3",
                // Data antiga para simular APTO (> 6 meses)
                dataEntrada: "2025-01-01T12:00:00.000Z", 
                // Pagou Jan, Fev, Mar de 2026
                historicoPagamentos: ["2026-01", "2026-02", "2026-03"],
                ativo: true
            },
            {
                id: 102,
                nome: "Lucas Silva (Exemplo Carência)",
                cpf: "987.654.321-99",
                foto: "https://i.pravatar.cc/150?img=8",
                // Data recente (mês passado)
                dataEntrada: new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString(),
                // Pagou apenas o mês atual
                historicoPagamentos: [new Date().toISOString().slice(0, 7)],
                ativo: true
            },
            {
                id: 103,
                nome: "Diego Santos (Em Análise)",
                cpf: "456.789.123-44",
                foto: "https://i.pravatar.cc/150?img=12",
                dataEntrada: new Date().toISOString(),
                historicoPagamentos: [],
                ativo: false // Aguardando ADM
            }
        ];

        // --- BANCO DE DADOS ---
        // Carrega do localStorage OU usa os dados de exemplo se estiver vazio
        let participantes = JSON.parse(localStorage.getItem('db_plano_v6_demo')) || dadosExemplo;
        let fotoBase64 = ""; 
        let modoAdm = false;

        // Meses para exibição e seleção
        const mesesAno = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];

        // --- UTILITÁRIOS ---
        function copiarPix() {
            navigator.clipboard.writeText(CHAVE_PIX_REAL);
            alert("Chave Copiada! Faça o pagamento e depois envie o comprovante.");
        }

        document.getElementById('cpf').addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, "").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            e.target.value = v;
        });

        function lerFoto(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    fotoBase64 = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- FLUXO DE ADESÃO ---
        function solicitarAdesao() {
            const nome = document.getElementById('nome').value;
            const cpf = document.getElementById('cpf').value;
            
            if (!nome || !cpf || !fotoBase64) return alert("Preencha todos os campos e a foto!");

            if(confirm("Confirma que fez o PIX e quer enviar o comprovante?")) {
                const novo = {
                    id: Date.now(),
                    nome: nome,
                    cpf: cpf,
                    foto: fotoBase64,
                    dataEntrada: new Date().toISOString(),
                    historicoPagamentos: [], 
                    ativo: false
                };
                participantes.push(novo);
                salvarRenderizar();
                fecharModal('modal-inscricao');
                
                const texto = `*ADESÃO PLANO CIRURGIA*\nNome: ${nome}\nCPF: ${cpf}\n\n*Segue comprovante do PIX de R$ 100,00:*`;
                window.open(`https://wa.me/${ZAP_ADM}?text=${encodeURIComponent(texto)}`, '_blank');
            }
        }

        // --- ADM ---
        function loginAdmin() {
            if(prompt("Senha ADM:") === SENHA_ADM) {
                modoAdm = true;
                document.body.classList.add('modo-adm-ativo');
                renderizarTela();
                alert("Painel ADM Ativado!");
            }
        }

        // 1. ATIVAR USUÁRIO (O primeiro pagamento)
        function ativarUsuario(id) {
            if(confirm("Pagamento inicial recebido? ATIVAR usuário?")) {
                const p = participantes.find(x => x.id === id);
                p.ativo = true;
                p.dataEntrada = new Date().toISOString();
                
                // Registra o mês atual automaticamente como pago
                const hoje = new Date();
                const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2, '0')}`;
                p.historicoPagamentos = [mesAtual];
                
                salvarRenderizar();
            }
        }

        // 2. PAGAMENTO MENSAL (Abre Modal para escolher mês)
        function abrirModalPagamento(id) {
            const p = participantes.find(x => x.id === id);
            document.getElementById('id-atleta-pag').value = id;
            document.getElementById('nome-atleta-pag').innerText = p.nome;

            const select = document.getElementById('mes-pagamento');
            select.innerHTML = "";
            const anoAtual = new Date().getFullYear();
            
            // Gera opções para ano atual e próximo
            [anoAtual, anoAtual+1].forEach(ano => {
                mesesAno.forEach((mes, index) => {
                    const valorMes = `${ano}-${String(index+1).padStart(2, '0')}`;
                    // Só mostra se ainda NÃO foi pago
                    if(!p.historicoPagamentos.includes(valorMes)) {
                        const option = document.createElement('option');
                        option.value = valorMes;
                        option.text = `${mes}/${ano}`;
                        select.appendChild(option);
                    }
                });
            });

            document.getElementById('modal-pagamento').style.display = "flex";
        }

        function confirmarPagamentoMensal() {
            const id = parseInt(document.getElementById('id-atleta-pag').value);
            const mes = document.getElementById('mes-pagamento').value;
            
            if(!mes) return alert("Selecione um mês.");

            const p = participantes.find(x => x.id === id);
            p.historicoPagamentos.push(mes);
            p.historicoPagamentos.sort();
            
            salvarRenderizar();
            fecharModal('modal-pagamento');
        }

        function excluirUsuario(id) {
            if(confirm("Excluir cadastro permanentemente?")) {
                participantes = participantes.filter(x => x.id !== id);
                salvarRenderizar();
            }
        }

        function salvarRenderizar() {
            // Usando uma nova chave para garantir que os dados de exemplo apareçam
            localStorage.setItem('db_plano_v6_demo', JSON.stringify(participantes));
            renderizarTela();
        }

        // --- RENDERIZAÇÃO ---
        function calcularCarencia(dataEntrada) {
            const diffDays = Math.ceil(Math.abs(new Date() - new Date(dataEntrada)) / (1000 * 60 * 60 * 24));
            return diffDays >= 180;
        }

        // Converte "2026-01" -> "JAN"
        function formatarMesCurto(anoMes) {
            const [ano, mes] = anoMes.split('-');
            const nomes = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
            return nomes[parseInt(mes)-1];
        }

        function renderizarTela() {
            const lista = document.getElementById('lista-participantes');
            lista.innerHTML = "";
            let saldo = 0, aptos = 0, carencia = 0, analise = 0;

            const listaOrdenada = participantes.sort((a, b) => a.ativo === b.ativo ? 0 : a.ativo ? 1 : -1);

            listaOrdenada.forEach(p => {
                const qtdPagos = p.historicoPagamentos ? p.historicoPagamentos.length : 0;
                const total = qtdPagos * VALOR_MENSAL;
                
                if(p.ativo) saldo += total;

                // Status
                let badgeHTML = "";
                let classRow = "";

                if(!p.ativo) {
                    analise++;
                    badgeHTML = `<span class="badge bg-analise">EM ANÁLISE</span>`;
                    classRow = "opacity: 0.6;";
                } else {
                    const isApto = calcularCarencia(p.dataEntrada);
                    if(isApto) { aptos++; badgeHTML = `<span class="badge bg-apto">APTO</span>`; }
                    else { carencia++; badgeHTML = `<span class="badge bg-carencia">CARÊNCIA</span>`; }
                }

                // Renderiza as tags dos meses
                let mesesHTML = "";
                if(p.historicoPagamentos && p.historicoPagamentos.length > 0) {
                    mesesHTML = `<div class="meses-grid">`;
                    // Mostra os últimos 6
                    const ultimos = p.historicoPagamentos.slice(-6);
                    ultimos.forEach(m => {
                        mesesHTML += `<span class="tag-mes">${formatarMesCurto(m)}</span>`;
                    });
                    if(p.historicoPagamentos.length > 6) mesesHTML += `<span class="tag-mes" style="background:#ccc; color:#555;">+${p.historicoPagamentos.length-6}</span>`;
                    mesesHTML += `</div>`;
                } else if (p.ativo) {
                    mesesHTML = `<div class="meses-grid"><span style="font-size:9px; color:#999;">Nenhum pagamento registrado</span></div>`;
                }

                const cpfOculto = p.cpf.replace(/^(\d{3})\.(\d{3})/, "***.***");

                // Botões ADM
                let btnPrincipal = !p.ativo 
                    ? `<button class="btn-adm btn-ativar" onclick="ativarUsuario(${p.id})">ATIVAR</button>`
                    : `<button class="btn-adm btn-pay" onclick="abrirModalPagamento(${p.id})">+ MÊS</button>`;

                const controls = `
                    <div class="admin-controls">
                        ${btnPrincipal}
                        <button class="btn-adm btn-del" onclick="excluirUsuario(${p.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;

                lista.innerHTML += `
                    <div class="atleta-row" style="${classRow}">
                        <img src="${p.foto}" class="foto-perfil">
                        <div class="info-atleta">
                            <span class="nome">${p.nome} ${badgeHTML}</span>
                            <div class="cpf-mask">CPF: ${cpfOculto}</div>
                            ${mesesHTML}
                            ${modoAdm ? controls : ''}
                        </div>
                        <div class="valor-pago">R$ ${total.toFixed(0)}</div>
                    </div>
                `;
            });

            document.getElementById('saldo-total').innerText = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('qtd-aptos').innerText = aptos;
            document.getElementById('qtd-carencia').innerText = carencia;
            document.getElementById('qtd-analise').innerText = analise;
        }

        function abrirModal(id) { document.getElementById(id).style.display = "flex"; }
        function fecharModal(id) { document.getElementById(id).style.display = "none"; }

        renderizarTela();

    </script>
</body>
</html>